<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="color-scheme" content="light">
    <title>BodyComp - Avaliação & Prescrição</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;0,700;1,400&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              nature: {
                50: '#f2fcf5',
                100: '#e1f8e8',
                200: '#c3eed0',
                300: '#94e0ad',
                400: '#5bcb86',
                500: '#34b166',
                600: '#26904f',
                700: '#217242',
                800: '#1e5b37',
                900: '#194b2f',
              },
              vitality: {
                50: '#fff8f1',
                100: '#ffefdb',
                500: '#f97316',
                600: '#ea580c',
              },
              earth: {
                50: '#fafaf9',
                100: '#f5f5f4',
                200: '#e7e5e4',
                800: '#44403c',
                900: '#292524',
              }
            },
            fontFamily: {
              sans: ['Outfit', 'system-ui', 'sans-serif'],
              serif: ['Lora', 'serif'],
            },
            screens: {
              'print': {'raw': 'print'},
              'xs': '375px',
            },
            boxShadow: {
              'soft': '0 10px 40px -10px rgba(0, 0, 0, 0.08)',
              'card': '0 0 0 1px rgba(0,0,0,0.03), 0 2px 8px rgba(0,0,0,0.04)',
            }
          }
        }
      }
    </script>
    <style>
      :root { color-scheme: light; }
      body { 
        font-family: 'Outfit', sans-serif; 
        background-color: #f4f6f5; 
        background-image: radial-gradient(#dcfce7 1px, transparent 1px); 
        background-size: 32px 32px; 
      }
      
      .transition-interactive { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

      /* Input Styles - Modern & Touch Friendly */
      .input-modern {
        @apply w-full px-4 py-3 rounded-xl outline-none transition-all duration-300 text-base shadow-sm;
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        color: #1e293b;
        -webkit-appearance: none; /* iOS Reset */
      }
      .input-modern::placeholder { color: #94a3b8; }
      .input-modern:focus {
        @apply ring-2 ring-nature-200 border-nature-500 shadow-md;
        background-color: #ffffff;
      }
      
      /* Tabs */
      .tab-btn {
        @apply flex-1 md:flex-none px-4 py-3 font-semibold text-sm tracking-wide text-earth-800 border-b-2 border-transparent transition-all duration-300 hover:text-nature-600 text-center;
      }
      .tab-btn.active {
        @apply text-nature-700 border-nature-600 bg-nature-50/50 rounded-t-lg;
      }

      /* Search Results */
      .search-results {
        @apply absolute left-0 right-0 bg-white border border-earth-200 rounded-xl shadow-xl max-h-60 overflow-y-auto z-50 mt-1;
      }
      .search-item {
        @apply px-4 py-3 hover:bg-nature-50 cursor-pointer text-sm text-earth-800 border-b border-earth-50 last:border-0 transition-colors;
      }

      /* Modal Utilities */
      .modal-backdrop {
        background-color: rgba(20, 40, 30, 0.6);
        backdrop-filter: blur(4px);
      }

      /* Helper Classes */
      .label-sm { display: block; font-size: 0.75rem; color: #64748b; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em; margin-bottom: 6px; }
      .section-title { 
        display: flex; align-items: center; gap: 8px; 
        color: #1e5b37; /* Nature 800 */
        font-family: 'Lora', serif;
        font-weight: 700; 
        font-size: 1.1rem;
        border-bottom: 2px solid #e1f8e8; 
        padding-bottom: 6px; margin-bottom: 16px; 
      }
      
      /* Print Optimization */
      @media print {
        @page { size: A4; margin: 0; }
        body { background: white; font-size: 9pt; -webkit-print-color-adjust: exact; }
        .no-print { display: none !important; }
        #form-view { display: none !important; }
        #report-view { 
          display: flex !important; opacity: 1 !important; visibility: visible !important; 
          position: relative; width: 100%; height: auto; margin: 0; padding: 0 !important;
          background: white;
        }
        #printable-content {
            box-shadow: none !important;
            max-width: 100% !important;
            width: 100% !important;
            border: none !important;
            border-radius: 0 !important;
            min-height: auto !important;
        }
        
        header { padding: 20px 30px 10px 30px !important; margin-bottom: 0 !important; }
        .tab-content { padding: 10px 30px !important; }
        
        /* Compact Grid */
        .print-grid-cols-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .print-text-sm { font-size: 8pt !important; }
        
        /* Ink Saving */
        .bg-gradient-to-r, .bg-gradient-to-br { background: none !important; border: 1px solid #ddd; color: #000 !important; }
        .text-white { color: #000 !important; }
        
        #skinfolds-circumferences-wrapper { display: grid; grid-template-columns: 0.6fr 1.4fr; gap: 20px; margin-top: 10px; }
        table th, table td { padding: 3px 6px !important; }
        footer { padding: 10px 30px !important; position: fixed; bottom: 0; width: 100%; }
      }
    </style>
</head>
<body class="antialiased text-earth-900 selection:bg-nature-200 selection:text-nature-900">

    <!-- FORM VIEW -->
    <div id="form-view" class="min-h-screen flex flex-col items-center justify-center p-3 md:p-6 lg:p-12 transition-opacity duration-500 ease-in-out">
        
        <div class="bg-white w-full max-w-5xl rounded-[2rem] shadow-soft overflow-hidden border border-white/60 relative">
            
            <!-- Header Banner -->
            <div class="bg-nature-800 relative overflow-hidden h-40 md:h-56 flex items-center px-6 md:px-12 transition-all duration-500">
                <!-- Decorative Elements -->
                <div class="absolute right-0 top-0 h-full w-2/3 md:w-1/2 bg-[url('https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80')] bg-cover bg-center opacity-20 mix-blend-luminosity"></div>
                <div class="absolute -left-10 -bottom-20 w-40 h-40 md:w-64 md:h-64 bg-nature-600 rounded-full mix-blend-multiply filter blur-3xl opacity-60"></div>
                
                <div class="relative z-10 text-white w-full flex flex-col md:flex-row justify-between md:items-start gap-4">
                    <div class="mt-2 md:mt-0">
                        <div class="flex items-center gap-2 mb-1 md:mb-2 text-nature-300 font-bold tracking-widest text-[10px] md:text-xs uppercase">
                            <i data-lucide="activity" width="14"></i> Professional System
                        </div>
                        <h1 class="text-3xl md:text-5xl font-serif font-bold tracking-tight">BodyComp</h1>
                        <p class="text-nature-100 text-xs md:text-sm mt-1 font-light tracking-wide">Avaliação Física & Planejamento Nutricional</p>
                    </div>
                    
                    <div class="bg-white/10 backdrop-blur-md p-1 pl-2 pr-3 rounded-xl border border-white/20 flex items-center gap-2 max-w-xs md:mt-2">
                        <div class="bg-nature-700 p-2 rounded-lg">
                            <i data-lucide="user-check" class="text-white" width="16"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <label class="block text-[9px] text-nature-300 uppercase font-bold">Profissional</label>
                            <input type="text" id="nutritionistName" class="bg-transparent border-none text-white placeholder-nature-400 text-sm w-full focus:ring-0 p-0 outline-none font-medium truncate" placeholder="Seu Nome" />
                        </div>
                    </div>
                </div>
            </div>

            <form id="calc-form" class="p-6 md:p-10 space-y-12">
                
                <!-- Section 1: Dados do Paciente -->
                <section>
                    <h3 class="flex items-center gap-3 text-lg font-serif font-bold text-nature-800 mb-6">
                        <span class="w-8 h-8 rounded-full bg-nature-100 flex items-center justify-center text-nature-600 border border-nature-200"><i data-lucide="user" width="16"></i></span>
                        Dados do Paciente
                    </h3>
                    <!-- Uniform Card Layout for Patient Data -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6">
                        
                        <!-- Name Card (Full width on mobile, 2 cols on desktop) -->
                        <div class="md:col-span-4 bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col gap-1 transition-all hover:border-nature-300">
                            <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest px-1">Nome Completo</label>
                            <input type="text" id="name" required class="w-full text-lg font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="Ex: Maria Silva" />
                        </div>

                        <!-- Gender Card -->
                        <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 relative group">
                            <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Gênero</label>
                            <div class="w-full relative">
                                <select id="gender" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent appearance-none cursor-pointer">
                                    <option value="male">Masculino</option>
                                    <option value="female">Feminino</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-0 top-1.5 text-nature-300 pointer-events-none opacity-50" width="16"></i>
                            </div>
                        </div>

                        <!-- Age Card -->
                        <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                            <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Idade (anos)</label>
                            <input type="number" id="age" value="30" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" />
                        </div>
                        
                        <!-- Weight Card -->
                        <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                            <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Peso (kg)</label>
                            <input type="number" id="weight" value="70" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" />
                        </div>

                        <!-- Height Card -->
                        <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                            <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Altura (cm)</label>
                            <input type="number" id="height" value="170" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" />
                        </div>
                    </div>
                </section>

                <div class="border-t border-dashed border-gray-200"></div>

                <!-- Section 2: Dobras -->
                <section>
                    <h3 class="flex items-center gap-3 text-lg font-serif font-bold text-nature-800 mb-6">
                        <span class="w-8 h-8 rounded-full bg-vitality-100 flex items-center justify-center text-vitality-600 border border-vitality-200"><i data-lucide="pincers" width="16"></i></span>
                        Dobras Cutâneas (mm)
                    </h3>
                    <div class="bg-nature-50/30 rounded-3xl border border-nature-100 p-5 md:p-8">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-8">
                            <!-- Card Style for Skinfolds (Reference Style) -->
                            <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                                <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Peitoral</label>
                                <input type="number" id="sf-chest" value="10" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="0" />
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                                <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Axilar</label>
                                <input type="number" id="sf-axilla" value="10" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="0" />
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                                <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Tríceps</label>
                                <input type="number" id="sf-tricep" value="10" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="0" />
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                                <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Subescapular</label>
                                <input type="number" id="sf-subscapular" value="10" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="0" />
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                                <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Abdomen</label>
                                <input type="number" id="sf-abdomen" value="20" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="0" />
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                                <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Supra-ilíaca</label>
                                <input type="number" id="sf-suprailiac" value="15" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="0" />
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                                <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Coxa</label>
                                <input type="number" id="sf-thigh" value="15" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="0" />
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section 3: Perímetros -->
                <section>
                    <h3 class="flex items-center gap-3 text-lg font-serif font-bold text-nature-800 mb-6">
                        <span class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 border border-blue-100"><i data-lucide="ruler" width="16"></i></span>
                        Perimetria (cm)
                    </h3>
                    
                    <div class="flex flex-col gap-10">
                        
                        <!-- TRONCO (3 cols) - Updated to Card Style -->
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-widest pb-2 border-b border-gray-100">
                                <div class="w-1.5 h-1.5 rounded-full bg-blue-400"></div> Tronco & Cabeça (Medida Única)
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-5">
                                <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                                    <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Pescoço</label>
                                    <input type="number" id="cf-neck" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="-" />
                                </div>
                                <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                                    <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Ombro</label>
                                    <input type="number" id="cf-shoulder" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="-" />
                                </div>
                                <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                                    <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Tórax</label>
                                    <input type="number" id="cf-chest" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="-" />
                                </div>
                                <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                                    <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Abdomen</label>
                                    <input type="number" id="cf-abdomen" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="-" />
                                </div>
                                <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                                    <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Cintura</label>
                                    <input type="number" id="cf-waist" value="80" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="-" />
                                </div>
                                <div class="bg-white p-3 rounded-xl border border-nature-100/50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all hover:border-nature-300 group">
                                    <label class="text-[10px] font-bold text-nature-500 uppercase tracking-widest text-center">Quadril</label>
                                    <input type="number" id="cf-hip" value="100" step="0.1" class="w-full text-center text-xl font-bold text-nature-800 outline-none bg-transparent placeholder-gray-300" placeholder="-" />
                                </div>
                            </div>
                        </div>

                        <!-- MEMBROS (2 col grid of cards) - Updated Container Style -->
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 text-xs font-bold text-gray-400 uppercase tracking-widest pb-2 border-b border-gray-100">
                                <div class="w-1.5 h-1.5 rounded-full bg-blue-400"></div> Membros (Medidas Bilaterais)
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                
                                <!-- Card: Braço Relaxado -->
                                <div class="bg-white p-4 rounded-xl border border-nature-100/50 shadow-sm hover:border-nature-300 transition-all">
                                    <div class="flex justify-between items-center mb-3">
                                        <span class="text-[10px] font-bold text-nature-500 uppercase tracking-widest">Braço Relaxado</span>
                                    </div>
                                    <div class="flex gap-4">
                                        <div class="flex-1 relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-nature-300">E</span>
                                            <input type="number" id="cf-armLeftRelaxed" class="w-full pl-8 pr-3 py-2 bg-gray-50 border border-gray-100 rounded-lg text-center font-bold text-nature-800 text-sm focus:bg-white focus:border-nature-200 focus:ring-1 focus:ring-nature-200 outline-none transition-all" placeholder="-" />
                                        </div>
                                        <div class="flex-1 relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-nature-300">D</span>
                                            <input type="number" id="cf-armRightRelaxed" value="30" class="w-full pl-8 pr-3 py-2 bg-gray-50 border border-gray-100 rounded-lg text-center font-bold text-nature-800 text-sm focus:bg-white focus:border-nature-200 focus:ring-1 focus:ring-nature-200 outline-none transition-all" placeholder="-" />
                                        </div>
                                    </div>
                                </div>

                                <!-- Card: Braço Contraído -->
                                <div class="bg-white p-4 rounded-xl border border-nature-100/50 shadow-sm hover:border-nature-300 transition-all">
                                    <div class="flex justify-between items-center mb-3">
                                        <span class="text-[10px] font-bold text-nature-500 uppercase tracking-widest">Braço Contraído</span>
                                    </div>
                                    <div class="flex gap-4">
                                        <div class="flex-1 relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-nature-300">E</span>
                                            <input type="number" id="cf-armLeftContracted" class="w-full pl-8 pr-3 py-2 bg-gray-50 border border-gray-100 rounded-lg text-center font-bold text-nature-800 text-sm focus:bg-white focus:border-nature-200 focus:ring-1 focus:ring-nature-200 outline-none transition-all" placeholder="-" />
                                        </div>
                                        <div class="flex-1 relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-nature-300">D</span>
                                            <input type="number" id="cf-armRightContracted" class="w-full pl-8 pr-3 py-2 bg-gray-50 border border-gray-100 rounded-lg text-center font-bold text-nature-800 text-sm focus:bg-white focus:border-nature-200 focus:ring-1 focus:ring-nature-200 outline-none transition-all" placeholder="-" />
                                        </div>
                                    </div>
                                </div>

                                <!-- Card: Coxa -->
                                <div class="bg-white p-4 rounded-xl border border-nature-100/50 shadow-sm hover:border-nature-300 transition-all">
                                    <div class="flex justify-between items-center mb-3">
                                        <span class="text-[10px] font-bold text-nature-500 uppercase tracking-widest">Coxa Medial</span>
                                    </div>
                                    <div class="flex gap-4">
                                        <div class="flex-1 relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-nature-300">E</span>
                                            <input type="number" id="cf-thighLeftMedial" class="w-full pl-8 pr-3 py-2 bg-gray-50 border border-gray-100 rounded-lg text-center font-bold text-nature-800 text-sm focus:bg-white focus:border-nature-200 focus:ring-1 focus:ring-nature-200 outline-none transition-all" placeholder="-" />
                                        </div>
                                        <div class="flex-1 relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-nature-300">D</span>
                                            <input type="number" id="cf-thighRightMedial" class="w-full pl-8 pr-3 py-2 bg-gray-50 border border-gray-100 rounded-lg text-center font-bold text-nature-800 text-sm focus:bg-white focus:border-nature-200 focus:ring-1 focus:ring-nature-200 outline-none transition-all" placeholder="-" />
                                        </div>
                                    </div>
                                </div>

                                <!-- Card: Panturrilha -->
                                <div class="bg-white p-4 rounded-xl border border-nature-100/50 shadow-sm hover:border-nature-300 transition-all">
                                    <div class="flex justify-between items-center mb-3">
                                        <span class="text-[10px] font-bold text-nature-500 uppercase tracking-widest">Panturrilha</span>
                                    </div>
                                    <div class="flex gap-4">
                                        <div class="flex-1 relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-nature-300">E</span>
                                            <input type="number" id="cf-calfLeft" class="w-full pl-8 pr-3 py-2 bg-gray-50 border border-gray-100 rounded-lg text-center font-bold text-nature-800 text-sm focus:bg-white focus:border-nature-200 focus:ring-1 focus:ring-nature-200 outline-none transition-all" placeholder="-" />
                                        </div>
                                        <div class="flex-1 relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-nature-300">D</span>
                                            <input type="number" id="cf-calfRight" class="w-full pl-8 pr-3 py-2 bg-gray-50 border border-gray-100 rounded-lg text-center font-bold text-nature-800 text-sm focus:bg-white focus:border-nature-200 focus:ring-1 focus:ring-nature-200 outline-none transition-all" placeholder="-" />
                                        </div>
                                    </div>
                                </div>

                                <!-- Hidden extra inputs logic preserved -->
                                <div class="hidden">
                                    <input id="cf-forearmLeft"><input id="cf-forearmRight">
                                    <input id="cf-thighLeftProximal"><input id="cf-thighRightProximal">
                                    <input id="cf-thighLeftDistal"><input id="cf-thighRightDistal">
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <div class="pt-6 pb-2">
                    <button type="submit" class="w-full bg-gradient-to-r from-nature-600 to-nature-500 hover:from-nature-700 hover:to-nature-600 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl hover:shadow-nature-500/30 transform transition-all duration-300 hover:-translate-y-1 active:scale-95 flex justify-center items-center gap-3 cursor-pointer group">
                        <span class="text-lg tracking-wide">Gerar Relatório Completo</span>
                        <div class="bg-white/20 p-1.5 rounded-full group-hover:bg-white/30 transition-colors">
                            <i data-lucide="arrow-right" width="20"></i>
                        </div>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- App Credits -->
        <div class="mt-8 mb-4 text-gray-400 text-xs font-medium text-center tracking-wide opacity-80">
            Desenvolvido por <a href="https://instagram.com/tiagovieira.films" target="_blank" class="text-nature-600 hover:text-nature-800 transition-colors font-bold">@tiagovieira.films</a>
        </div>
    </div>

    <!-- REPORT VIEW -->
    <div id="report-view" class="hidden min-h-screen bg-earth-50 justify-center p-0 md:p-8 opacity-0 transition-opacity duration-700 ease-in-out">
        
        <div id="printable-content" class="w-full md:max-w-[210mm] bg-white shadow-none md:shadow-soft print:shadow-none print:w-full overflow-hidden flex flex-col min-h-screen md:min-h-[297mm] rounded-none md:rounded-2xl border-none md:border border-earth-100">
            
            <!-- Controls (Screen Only) -->
            <div class="no-print p-4 flex justify-between items-center bg-white border-b border-earth-200 sticky top-0 z-50 shadow-sm md:shadow-none">
                <button type="button" id="btn-back" class="flex items-center gap-2 text-sm font-semibold text-earth-800 hover:text-nature-600 transition-colors cursor-pointer group px-3 py-2 rounded-lg hover:bg-earth-50">
                    <i data-lucide="arrow-left" width="18" class="transition-transform group-hover:-translate-x-1"></i> <span class="hidden xs:inline">Voltar</span>
                </button>
                <div class="flex bg-earth-100 p-1 rounded-lg">
                    <button type="button" id="tab-assess" class="px-4 py-1.5 text-xs md:text-sm font-bold rounded-md shadow-sm bg-white text-nature-700 transition-all">Avaliação</button>
                    <button type="button" id="tab-diet" class="px-4 py-1.5 text-xs md:text-sm font-medium rounded-md text-earth-600 hover:text-nature-700 transition-all">Dieta</button>
                </div>
                <button type="button" id="btn-print" class="flex items-center gap-2 px-3 md:px-5 py-2 bg-nature-600 hover:bg-nature-700 text-white rounded-lg font-bold shadow-md hover:shadow-lg transition-all text-sm">
                    <i data-lucide="printer" width="16"></i> <span class="hidden xs:inline">Imprimir</span>
                </button>
            </div>

            <!-- Report Header -->
            <div class="px-6 md:px-10 pt-8 pb-4 print:px-8 print:pt-8 print:pb-4 flex flex-col gap-4">
                <header class="flex flex-col xs:flex-row justify-between items-start xs:items-end border-b-2 border-nature-100 pb-4 gap-4 xs:gap-0 print:flex-row print:pb-2">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-nature-50 rounded-xl flex items-center justify-center text-nature-600 border border-nature-100 print:border-gray-300">
                            <i data-lucide="activity" width="24"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-serif font-bold text-nature-900 leading-none">BodyComp</h1>
                            <p id="r-nutri-name" class="text-earth-600 text-sm font-medium mt-1">Nutricionista</p>
                        </div>
                    </div>
                    <div class="text-left xs:text-right w-full xs:w-auto">
                        <div id="r-date" class="text-sm font-serif italic text-gray-500"></div>
                        <div class="text-[10px] text-gray-400 mt-1 uppercase tracking-wide font-bold">Relatório Oficial</div>
                    </div>
                </header>

                <!-- Patient Summary Strip -->
                <div class="bg-nature-50/30 rounded-xl p-4 border border-nature-100 print:bg-white print:border-gray-200 print:p-2">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm items-center">
                        <div class="col-span-2 md:border-r border-nature-200 md:pr-4">
                            <span class="label-sm">Paciente</span>
                            <span id="r-name" class="block text-xl font-serif font-bold text-earth-900 truncate"></span>
                        </div>
                        <div>
                            <span class="label-sm">Perfil</span>
                            <span id="r-age-gender" class="font-medium text-earth-800"></span>
                        </div>
                        <div class="text-left md:text-right">
                            <span class="label-sm">Peso Atual</span>
                            <span id="r-weight" class="font-bold text-lg text-nature-700"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 1: ASSESSMENT (Print Optimized) -->
            <div id="content-assessment" class="tab-content px-6 md:px-10 pb-10 flex-grow flex flex-col gap-8 print:px-8 print:pb-0 print:gap-4">
                
                <!-- ROW 1: Composition & Goals -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 print:gap-6 print-grid-cols-2">
                    
                    <!-- LEFT: Composition -->
                    <div class="flex flex-col gap-4">
                        <h3 class="section-title"><i data-lucide="pie-chart" width="16"></i> Composição Corporal</h3>
                        
                        <div class="flex items-center gap-6 bg-white border border-gray-100 rounded-2xl p-4 shadow-sm print:shadow-none print:border-gray-200 print:p-2">
                            <div class="flex-shrink-0" id="pie-chart-container"></div>
                            <div class="flex-grow space-y-2 print:space-y-1.5 print:text-sm">
                                <div class="flex justify-between items-center"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span><span class="text-xs font-bold text-gray-600 uppercase">Músculo</span></div><span id="r-val-muscle" class="font-bold text-earth-900 text-sm"></span></div>
                                <div class="flex justify-between items-center"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-vitality-600"></span><span class="text-xs font-bold text-gray-600 uppercase">Gordura</span></div><span id="r-val-fat" class="font-bold text-earth-900 text-sm"></span></div>
                                <div class="flex justify-between items-center"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-nature-600"></span><span class="text-xs font-bold text-gray-600 uppercase">Osso</span></div><span id="r-val-bone" class="font-bold text-earth-900 text-sm"></span></div>
                                <div class="flex justify-between items-center"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-gray-400"></span><span class="text-xs font-bold text-gray-600 uppercase">Residual</span></div><span id="r-val-residual" class="font-bold text-earth-900 text-sm"></span></div>
                            </div>
                        </div>

                        <div class="rounded-xl border border-gray-100 overflow-hidden text-sm shadow-sm print:shadow-none print:border-gray-200">
                            <table class="w-full">
                                <thead class="bg-gray-50 text-gray-500 text-[10px] uppercase font-bold tracking-wider">
                                    <tr><th class="py-2 px-4 text-left">Indicador</th><th class="py-2 px-4 text-right">Atual</th><th class="py-2 px-4 text-right">Ideal</th></tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100 bg-white print:text-xs">
                                    <tr><td class="py-3 px-4 font-medium">Gordura (%)</td><td id="t-bf-curr" class="py-3 px-4 text-right font-bold text-vitality-600"></td><td id="t-bf-ideal" class="py-3 px-4 text-right text-gray-400"></td></tr>
                                    <tr><td class="py-3 px-4 font-medium">Massa Gorda (kg)</td><td id="t-fm-curr" class="py-3 px-4 text-right font-bold"></td><td id="t-fm-ideal" class="py-3 px-4 text-right text-gray-400"></td></tr>
                                    <tr><td class="py-3 px-4 font-medium">Massa Magra (kg)</td><td id="t-mm-curr" class="py-3 px-4 text-right font-bold text-nature-700"></td><td class="py-3 px-4 text-right text-gray-400">-</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- RIGHT: Metabolism & Status -->
                    <div class="flex flex-col gap-4">
                        <h3 class="section-title"><i data-lucide="target" width="16"></i> Estado & Metas</h3>
                        
                        <div class="bg-gradient-to-br from-nature-800 to-nature-900 rounded-2xl p-6 text-white shadow-md print:bg-white print:border print:border-gray-200 print:text-black print:shadow-none print:p-0">
                            <div class="flex justify-between items-end mb-6 print:mb-2">
                                <div>
                                    <div class="text-nature-300 text-[10px] uppercase font-bold tracking-widest mb-1 print:text-gray-500">Metabolismo Basal</div>
                                    <div class="text-4xl font-serif font-bold tracking-tight"><span id="r-bmr"></span> <span class="text-base font-sans font-medium text-nature-300 print:text-gray-600">kcal</span></div>
                                </div>
                                <div class="text-right">
                                    <div class="text-nature-300 text-[10px] uppercase font-bold tracking-widest mb-1 print:text-gray-500">Peso Ideal</div>
                                    <div id="r-ideal-weight-range" class="text-xl font-bold"></div>
                                </div>
                            </div>
                            <div id="range-bars-container" class="bg-white/10 p-4 rounded-xl backdrop-blur-sm space-y-3 print:bg-transparent print:p-0"></div>
                        </div>
                    </div>
                </div>

                <!-- ROW 2: Detailed Data (Side by Side for Print) -->
                <div id="skinfolds-circumferences-wrapper" class="grid grid-cols-1 md:grid-cols-12 gap-8 print:grid-cols-2 print:gap-6 print:mt-4">
                    
                    <!-- Skinfolds -->
                    <div class="md:col-span-4 print:col-span-1">
                        <h3 class="section-title"><i data-lucide="layers" width="16"></i> Dobras (mm)</h3>
                        <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 print:bg-white print:border-gray-200 print:p-0">
                            <div class="grid grid-cols-2 md:grid-cols-1 gap-3" id="r-skinfolds-grid">
                                <!-- Injected JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Circumferences -->
                    <div class="md:col-span-8 print:col-span-1">
                        <h3 class="section-title"><i data-lucide="maximize-2" width="16"></i> Perímetros (cm)</h3>
                        <div class="rounded-xl border border-gray-100 overflow-hidden text-xs print:border-gray-200">
                            <table class="w-full">
                                <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-[10px] tracking-wider print:bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-3 text-left">Local</th>
                                        <th class="py-2 px-3 text-center">Esq.</th>
                                        <th class="py-2 px-3 text-center">Dir.</th>
                                    </tr>
                                </thead>
                                <tbody id="circumferences-table-body" class="divide-y divide-gray-50 print:divide-gray-100 bg-white">
                                    <!-- Injected JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: DIET PLANNER -->
            <div id="content-diet" class="tab-content hidden px-6 md:px-10 pb-10 flex-grow flex flex-col gap-6">
                
                <!-- Diet Summary Header -->
                <div class="bg-nature-50 border border-nature-100 rounded-xl p-5 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex gap-8 items-center w-full md:w-auto justify-center">
                        <div class="text-center">
                            <span class="label-sm">Meta</span>
                            <span id="diet-target-cal" class="text-xl font-bold text-nature-700 font-serif">2000 kcal</span>
                        </div>
                        <div class="h-10 w-px bg-nature-200"></div>
                        <div class="text-center">
                            <span class="label-sm">Total</span>
                            <span id="diet-total-cal" class="text-xl font-bold text-earth-900 font-serif">0 kcal</span>
                        </div>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto justify-center text-xs">
                        <div class="flex-1 md:flex-none text-center px-3 py-2 bg-blue-100 text-blue-800 rounded-lg font-bold border border-blue-200">Prot: <span id="diet-total-prot">0</span>g</div>
                        <div class="flex-1 md:flex-none text-center px-3 py-2 bg-vitality-100 text-vitality-800 rounded-lg font-bold border border-vitality-200">Carb: <span id="diet-total-carb">0</span>g</div>
                        <div class="flex-1 md:flex-none text-center px-3 py-2 bg-yellow-100 text-yellow-800 rounded-lg font-bold border border-yellow-200">Gord: <span id="diet-total-fat">0</span>g</div>
                    </div>
                </div>

                <!-- Add Food Tool (No Print) -->
                <div class="no-print bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                    <h3 class="text-sm font-bold text-earth-800 uppercase mb-4 flex items-center gap-2">
                        <i data-lucide="plus-circle" width="16" class="text-nature-500"></i> Adicionar Alimento
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end relative">
                        <!-- Meal Select -->
                        <div class="md:col-span-3">
                            <label class="label-sm">Refeição</label>
                            <select id="food-meal-select" class="input-modern py-2 text-sm bg-gray-50 border-gray-200">
                                <option value="cafe">Café da Manhã</option>
                                <option value="almoco">Almoço</option>
                                <option value="lanche">Lanche</option>
                                <option value="jantar">Jantar</option>
                            </select>
                        </div>
                        <!-- Search Input -->
                        <div class="md:col-span-5 relative">
                            <label class="label-sm">Buscar Alimento (TACO)</label>
                            <div class="relative">
                                <i data-lucide="search" class="absolute left-3 top-2.5 text-gray-400" width="14"></i>
                                <input type="text" id="food-search" class="input-modern py-2 pl-9 text-sm border-gray-200" placeholder="Ex: Arroz, Frango..." autocomplete="off">
                            </div>
                            <!-- Results Dropdown -->
                            <div id="food-search-results" class="search-results hidden"></div>
                        </div>
                        <!-- Quantity -->
                        <div class="grid grid-cols-2 gap-4 md:col-span-4 w-full">
                            <div>
                                <label class="label-sm">Qtd (g)</label>
                                <input type="number" id="food-qty" class="input-modern py-2 text-sm border-gray-200" value="100">
                            </div>
                            <!-- Button -->
                            <div>
                                <label class="label-sm opacity-0">Add</label>
                                <button type="button" id="btn-add-food" class="w-full bg-nature-600 hover:bg-nature-700 text-white font-bold py-2 rounded-xl text-sm transition-colors shadow-sm h-[40px]">
                                    Adicionar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Meals Container -->
                <div id="diet-meals-container" class="space-y-6">
                    <!-- Meals will be injected here -->
                </div>
                
                <!-- COPY MEAL MODAL -->
                <div id="copy-meal-modal" class="hidden fixed inset-0 z-[100] modal-backdrop flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm animate-fade-in border border-nature-100">
                        <div class="flex items-center gap-2 text-nature-700 mb-2">
                            <i data-lucide="copy" width="20"></i>
                            <h3 class="text-lg font-serif font-bold">Duplicar Refeição</h3>
                        </div>
                        <p class="text-sm text-gray-500 mb-6">Copiar itens de <span id="copy-source-name" class="font-bold text-nature-700"></span> para:</p>
                        
                        <div class="space-y-2">
                            <button onclick="confirmCopyMeal('cafe')" class="w-full p-3 text-left bg-gray-50 hover:bg-nature-50 rounded-xl border border-gray-100 hover:border-nature-200 transition-colors text-sm font-semibold text-gray-700 flex justify-between items-center group">
                                Café da Manhã <i data-lucide="arrow-right" width="14" class="opacity-0 group-hover:opacity-100 text-nature-500"></i>
                            </button>
                            <button onclick="confirmCopyMeal('almoco')" class="w-full p-3 text-left bg-gray-50 hover:bg-nature-50 rounded-xl border border-gray-100 hover:border-nature-200 transition-colors text-sm font-semibold text-gray-700 flex justify-between items-center group">
                                Almoço <i data-lucide="arrow-right" width="14" class="opacity-0 group-hover:opacity-100 text-nature-500"></i>
                            </button>
                            <button onclick="confirmCopyMeal('lanche')" class="w-full p-3 text-left bg-gray-50 hover:bg-nature-50 rounded-xl border border-gray-100 hover:border-nature-200 transition-colors text-sm font-semibold text-gray-700 flex justify-between items-center group">
                                Lanche <i data-lucide="arrow-right" width="14" class="opacity-0 group-hover:opacity-100 text-nature-500"></i>
                            </button>
                            <button onclick="confirmCopyMeal('jantar')" class="w-full p-3 text-left bg-gray-50 hover:bg-nature-50 rounded-xl border border-gray-100 hover:border-nature-200 transition-colors text-sm font-semibold text-gray-700 flex justify-between items-center group">
                                Jantar <i data-lucide="arrow-right" width="14" class="opacity-0 group-hover:opacity-100 text-nature-500"></i>
                            </button>
                        </div>
                        
                        <div class="mt-6 pt-4 border-t border-gray-100">
                            <button onclick="document.getElementById('copy-meal-modal').classList.add('hidden')" class="w-full py-2 text-center text-gray-400 hover:text-gray-600 text-sm font-bold">Cancelar</button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <footer class="p-6 border-t border-earth-100 bg-earth-50 text-[10px] text-gray-400 leading-tight mt-auto print:bg-white print:border-t print:border-gray-200 print:text-[8px]">
                <div class="flex flex-col md:flex-row justify-between gap-4">
                    <div>
                        <p class="mb-1 font-semibold text-nature-900">Protocolo Científico</p>
                        <p>Ref. Bibliográficas: Jackson & Pollock (7 Dobras), Siri (1961), TACO (4ª Ed).</p>
                        <p class="mt-1">Desenvolvido por <a href="https://instagram.com/tiagovieira.films" target="_blank" class="text-nature-700 font-bold hover:underline">@tiagovieira.films</a></p>
                    </div>
                    <div id="r-footer-nutri" class="uppercase font-bold text-nature-800 text-right self-end"></div>
                </div>
            </footer>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 0. TACO MINI DATABASE (Subset) ---
        const TACO_DB = [
            { id: 1, name: "Arroz, tipo 1, cozido", kcal: 128, prot: 2.5, carb: 28.1, fat: 0.2 },
            { id: 2, name: "Arroz, integral, cozido", kcal: 112, prot: 2.6, carb: 25.8, fat: 1.0 },
            { id: 3, name: "Feijão, carioca, cozido", kcal: 76, prot: 4.8, carb: 13.6, fat: 0.5 },
            { id: 4, name: "Feijão, preto, cozido", kcal: 77, prot: 4.5, carb: 14.0, fat: 0.5 },
            { id: 5, name: "Frango, peito, filé, grelhado", kcal: 159, prot: 32.0, carb: 0.0, fat: 2.5 },
            { id: 6, name: "Frango, peito, cozido", kcal: 163, prot: 31.5, carb: 0.0, fat: 3.2 },
            { id: 7, name: "Carne, patinho, sem gordura, grelhado", kcal: 219, prot: 35.9, carb: 0.0, fat: 7.3 },
            { id: 8, name: "Ovo, galinha, inteiro, cozido", kcal: 146, prot: 13.3, carb: 0.6, fat: 9.5 },
            { id: 9, name: "Ovo, galinha, clara, cozida", kcal: 59, prot: 13.4, carb: 0.0, fat: 0.1 },
            { id: 10, name: "Banana, prata, crua", kcal: 98, prot: 1.3, carb: 26.0, fat: 0.1 },
            { id: 11, name: "Maçã, Fuji, com casca, crua", kcal: 56, prot: 0.3, carb: 15.2, fat: 0.1 },
            { id: 12, name: "Mamão, papaia, cru", kcal: 40, prot: 0.5, carb: 10.4, fat: 0.1 },
            { id: 13, name: "Pão, francês", kcal: 300, prot: 8.0, carb: 58.6, fat: 3.1 },
            { id: 14, name: "Pão, integral", kcal: 253, prot: 9.4, carb: 49.9, fat: 3.7 },
            { id: 15, name: "Leite, vaca, integral", kcal: 60, prot: 3.2, carb: 4.7, fat: 3.3 },
            { id: 16, name: "Leite, vaca, desnatado", kcal: 35, prot: 3.3, carb: 4.9, fat: 0.1 },
            { id: 17, name: "Queijo, mozarela", kcal: 330, prot: 22.6, carb: 3.0, fat: 25.2 },
            { id: 18, name: "Queijo, minas, frescal", kcal: 264, prot: 17.4, carb: 3.2, fat: 20.2 },
            { id: 19, name: "Iogurte, natural", kcal: 51, prot: 4.1, carb: 1.9, fat: 3.0 },
            { id: 20, name: "Aveia, flocos, crua", kcal: 394, prot: 13.9, carb: 66.6, fat: 8.5 },
            { id: 21, name: "Batata, doce, cozida", kcal: 77, prot: 0.6, carb: 18.4, fat: 0.1 },
            { id: 22, name: "Batata, inglesa, cozida", kcal: 52, prot: 1.2, carb: 11.9, fat: 0.0 },
            { id: 23, name: "Azeite, de oliva, extra virgem", kcal: 884, prot: 0.0, carb: 0.0, fat: 100.0 },
            { id: 24, name: "Castanha-do-brasil, crua", kcal: 643, prot: 14.5, carb: 15.1, fat: 63.5 },
            { id: 25, name: "Tapioca, goma", kcal: 242, prot: 0.0, carb: 60.0, fat: 0.0 },
            { id: 26, name: "Café, infusão (sem açúcar)", kcal: 1, prot: 0, carb: 0, fat: 0 },
            { id: 27, name: "Whey Protein (Média Padrão)", kcal: 380, prot: 75.0, carb: 10.0, fat: 5.0 },
            { id: 28, name: "Abacate, cru", kcal: 96, prot: 1.2, carb: 6.0, fat: 8.4 },
            { id: 29, name: "Tomate, salada", kcal: 15, prot: 1.1, carb: 3.1, fat: 0.2 },
            { id: 30, name: "Alface, crespa", kcal: 11, prot: 1.3, carb: 1.7, fat: 0.2 }
        ];

        // --- 1. CONFIG & UTILS ---
        const $ = (id) => document.getElementById(id);
        const getValue = (id) => { const v = $(id).value; return isNaN(v) ? v : Number(v); };
        const setText = (id, text) => { if($(id)) $(id).textContent = text; };

        // State
        let dietPlan = { cafe: [], almoco: [], lanche: [], jantar: [] };
        let currentBMR = 0;
        let currentSourceMealForCopy = null;

        // --- 2. CALCULATIONS ---
        const calculateComposition = (data, folds, circs) => {
            const { gender, age, weight, height } = data;
            const heightM = height / 100;
            const sumFolds = folds.chest + folds.axilla + folds.tricep + folds.subscapular + folds.abdomen + folds.suprailiac + folds.thigh;
            
            let bodyDensity = gender === 'male' 
                ? 1.112 - (0.00043499 * sumFolds) + (0.00000055 * sumFolds * sumFolds) - (0.00028826 * age)
                : 1.097 - (0.00046971 * sumFolds) + (0.00000056 * sumFolds * sumFolds) - (0.00012828 * age);

            const bodyFatPercent = Math.max(0, ((4.95 / Math.max(0.9, Math.min(1.2, bodyDensity))) - 4.50) * 100);
            const fatMass = weight * (bodyFatPercent / 100);
            const residualMass = gender === 'male' ? weight * 0.241 : weight * 0.209;
            const boneMass = gender === 'male' ? weight * 0.15 : weight * 0.13;
            const muscleMass = Math.max(0, weight - fatMass - residualMass - boneMass);
            const bmi = weight / (heightM * heightM);
            
            const minIdealWeight = 18.5 * (heightM * heightM);
            const maxIdealWeight = 24.9 * (heightM * heightM);
            
            let idealBF = gender === 'male' ? (age < 30 ? 14 : 20) : (age < 30 ? 20 : 26); 

            let bmr = gender === 'male'
                ? (10 * weight) + (6.25 * height) - (5 * age) + 5
                : (10 * weight) + (6.25 * height) - (5 * age) - 161;

            return {
                bmi, bodyFatPercent, fatMass, residualMass, boneMass, muscleMass,
                idealWeightRange: [minIdealWeight, maxIdealWeight],
                basalMetabolicRate: bmr, idealBodyFatPercent: idealBF
            };
        };

        // --- 3. UI GENERATORS ---
        function generateRangeBar(label, value, unit, ideal, min=10, max=50) {
             const percent = Math.min(Math.max(((value - min) / (max - min)) * 100, 0), 100);
             const colorClass = value > max || value < min ? 'bg-red-400' : 'bg-nature-600';
             return `<div class="flex items-center text-xs mb-2 group">
                <div class="w-24 font-bold text-gray-700 text-right pr-2 print:text-black">${label}</div>
                <div class="flex-grow h-2 bg-gray-200 rounded-full relative overflow-hidden print:bg-gray-100">
                    <div class="bar-animate h-full ${colorClass} rounded-full print:bg-black" style="width: ${percent}%"></div>
                </div>
                <div class="w-12 text-xs font-bold pl-2 text-gray-800 print:text-black">${value.toFixed(1)}</div>
             </div>`;
        }

        function generatePieChart(fat, muscle, residual, bone) {
             const total = fat + muscle + residual + bone;
             const pFat = (fat/total)*100, pMus = (muscle/total)*100, pRes = (residual/total)*100;
             const c = 2 * Math.PI * 16;
             return `<svg viewBox="0 0 50 50" class="w-24 h-24 transform -rotate-90">
                <circle cx="25" cy="25" r="16" fill="transparent" stroke="#3b82f6" stroke-width="12" stroke-dasharray="100 100" />
                <circle cx="25" cy="25" r="16" fill="transparent" stroke="#ea580c" stroke-width="12" stroke-dasharray="${(pFat+pRes+((bone/total)*100))/100 * c} 100" />
                <circle cx="25" cy="25" r="16" fill="transparent" stroke="#9ca3af" stroke-width="12" stroke-dasharray="${(pFat+pRes)/100 * c} 100" />
                <circle cx="25" cy="25" r="16" fill="transparent" stroke="#16a34a" stroke-width="12" stroke-dasharray="${(pFat/100) * c} 100" />
             </svg>`;
        }

        // --- 4. DIET PLANNER LOGIC ---
        function renderDietPlanner() {
            const container = $('diet-meals-container');
            container.innerHTML = '';
            
            const meals = [
                { id: 'cafe', label: 'Café da Manhã' },
                { id: 'almoco', label: 'Almoço' },
                { id: 'lanche', label: 'Lanche' },
                { id: 'jantar', label: 'Jantar' }
            ];

            let grandTotal = { kcal: 0, prot: 0, carb: 0, fat: 0 };

            meals.forEach(meal => {
                const foods = dietPlan[meal.id];
                const mealTotal = foods.reduce((acc, f) => ({
                    kcal: acc.kcal + f.calc.kcal, prot: acc.prot + f.calc.prot,
                    carb: acc.carb + f.calc.carb, fat: acc.fat + f.calc.fat
                }), { kcal: 0, prot: 0, carb: 0, fat: 0 });

                grandTotal.kcal += mealTotal.kcal;
                grandTotal.prot += mealTotal.prot;
                grandTotal.carb += mealTotal.carb;
                grandTotal.fat += mealTotal.fat;

                const html = `
                    <div class="border border-nature-100 rounded-xl overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow">
                        <div class="bg-nature-50 px-5 py-3 flex justify-between items-center border-b border-nature-100">
                            <h4 class="font-bold text-nature-900 uppercase text-xs tracking-wider flex items-center gap-2">
                                ${meal.label}
                                <button onclick="openCopyModal('${meal.id}', '${meal.label}')" class="text-nature-400 hover:text-nature-600 transition-colors p-1 rounded hover:bg-white no-print" title="Duplicar Refeição">
                                    <i data-lucide="copy" width="14"></i>
                                </button>
                            </h4>
                            <div class="text-[10px] font-bold text-nature-600">
                                ${Math.round(mealTotal.kcal)} kcal 
                                <span class="text-gray-300 mx-2">|</span> P: ${Math.round(mealTotal.prot)} C: ${Math.round(mealTotal.carb)} G: ${Math.round(mealTotal.fat)}
                            </div>
                        </div>
                        <div class="p-0">
                            ${foods.length === 0 
                                ? '<div class="p-4 text-xs text-center text-gray-400 italic">Nenhum alimento adicionado.</div>' 
                                : `<table class="w-full text-xs">
                                    <tbody class="divide-y divide-gray-50">
                                        ${foods.map((f, idx) => `
                                            <tr class="group hover:bg-nature-50/50 transition-colors">
                                                <td class="py-3 px-5 font-medium text-gray-700">${f.name}</td>
                                                <td class="py-3 px-2 text-right w-20">
                                                    <div class="flex items-center justify-end gap-1 group/edit">
                                                        <span class="text-gray-500">${f.qty}g</span>
                                                        <button onclick="editFoodQty('${meal.id}', ${idx})" class="text-nature-400 hover:text-nature-600 opacity-0 group-hover/edit:opacity-100 transition-opacity no-print">
                                                            <i data-lucide="pencil" width="12"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                                <td class="py-3 px-2 text-right font-bold text-gray-800 w-16">${Math.round(f.calc.kcal)}</td>
                                                <td class="py-3 px-3 text-right w-10 no-print">
                                                    <button onclick="removeFood('${meal.id}', ${idx})" class="text-gray-300 hover:text-red-500 p-1 transition-colors"><i data-lucide="trash-2" width="14"></i></button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                   </table>`
                            }
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });

            setText('diet-total-cal', Math.round(grandTotal.kcal) + ' kcal');
            setText('diet-total-prot', Math.round(grandTotal.prot));
            setText('diet-total-carb', Math.round(grandTotal.carb));
            setText('diet-total-fat', Math.round(grandTotal.fat));
            
            lucide.createIcons();
        }

        // --- 5. LOGIC HELPERS ---
        function addFoodToDiet(foodId, mealId, qty) {
            const food = TACO_DB.find(f => f.id === foodId);
            if (!food) return;
            const ratio = qty / 100;
            const item = {
                id: food.id,
                name: food.name,
                qty: qty,
                calc: { kcal: food.kcal * ratio, prot: food.prot * ratio, carb: food.carb * ratio, fat: food.fat * ratio }
            };
            dietPlan[mealId].push(item);
            renderDietPlanner();
        }

        window.removeFood = (mealId, idx) => { dietPlan[mealId].splice(idx, 1); renderDietPlanner(); };
        
        window.editFoodQty = (mealId, idx) => {
            const item = dietPlan[mealId][idx];
            const newQtyStr = prompt(`Nova quantidade para ${item.name} (g):`, item.qty);
            const newQty = parseInt(newQtyStr);
            if (!isNaN(newQty) && newQty > 0) {
                const baseFood = TACO_DB.find(f => f.id === item.id);
                if (baseFood) {
                    const ratio = newQty / 100;
                    item.qty = newQty;
                    item.calc = { kcal: baseFood.kcal * ratio, prot: baseFood.prot * ratio, carb: baseFood.carb * ratio, fat: baseFood.fat * ratio };
                    renderDietPlanner();
                }
            }
        };

        window.openCopyModal = (sourceId, sourceLabel) => {
            currentSourceMealForCopy = sourceId;
            setText('copy-source-name', sourceLabel);
            $('copy-meal-modal').classList.remove('hidden');
        };

        window.confirmCopyMeal = (targetId) => {
            if (!currentSourceMealForCopy || !dietPlan[currentSourceMealForCopy]) return;
            if (currentSourceMealForCopy === targetId) return alert("Origem e destino iguais.");
            const sourceItems = dietPlan[currentSourceMealForCopy];
            sourceItems.forEach(item => addFoodToDiet(item.id, targetId, item.qty));
            $('copy-meal-modal').classList.add('hidden');
            renderDietPlanner();
        };

        // --- 6. MAIN CONTROLLER ---
        const handleFormSubmit = (e) => {
            e.preventDefault();
            const patientData = {
                name: getValue('name'), age: getValue('age'), gender: getValue('gender'),
                weight: getValue('weight'), height: getValue('height')
            };
            const skinfolds = {
                chest: getValue('sf-chest'), axilla: getValue('sf-axilla'), tricep: getValue('sf-tricep'),
                subscapular: getValue('sf-subscapular'), abdomen: getValue('sf-abdomen'),
                suprailiac: getValue('sf-suprailiac'), thigh: getValue('sf-thigh')
            };
            const circs = {
                neck: getValue('cf-neck') || 0, shoulder: getValue('cf-shoulder') || 0, chest: getValue('cf-chest') || 0,
                abdomen: getValue('cf-abdomen') || 0, waist: getValue('cf-waist') || 0, hip: getValue('cf-hip') || 0,
                armLeftRelaxed: getValue('cf-armLeftRelaxed') || 0, armRightRelaxed: getValue('cf-armRightRelaxed') || 0,
                armLeftContracted: getValue('cf-armLeftContracted') || 0, armRightContracted: getValue('cf-armRightContracted') || 0,
                forearmLeft: getValue('cf-forearmLeft') || 0, forearmRight: getValue('cf-forearmRight') || 0,
                thighLeftProximal: getValue('cf-thighLeftProximal') || 0, thighRightProximal: getValue('cf-thighRightProximal') || 0,
                thighLeftMedial: getValue('cf-thighLeftMedial') || 0, thighRightMedial: getValue('cf-thighRightMedial') || 0,
                thighLeftDistal: getValue('cf-thighLeftDistal') || 0, thighRightDistal: getValue('cf-thighRightDistal') || 0,
                calfLeft: getValue('cf-calfLeft') || 0, calfRight: getValue('cf-calfRight') || 0
            };

            const res = calculateComposition(patientData, skinfolds, circs);
            currentBMR = Math.round(res.basalMetabolicRate);

            setText('r-nutri-name', getValue('nutritionistName') || 'Nutricionista');
            setText('r-footer-nutri', getValue('nutritionistName') || 'Profissional');
            setText('r-date', new Date().toLocaleDateString('pt-BR'));
            setText('r-name', patientData.name);
            setText('r-age-gender', `${patientData.age} anos | ${patientData.gender === 'male' ? 'Masculino' : 'Feminino'}`);
            setText('r-weight', `${patientData.weight} kg`);
            setText('r-bmr', currentBMR);
            setText('diet-target-cal', currentBMR + ' kcal');
            setText('r-ideal-weight-range', `${res.idealWeightRange[0].toFixed(1)} - ${res.idealWeightRange[1].toFixed(1)} kg`);

            $('pie-chart-container').innerHTML = generatePieChart(res.fatMass, res.muscleMass, res.residualMass, res.boneMass);
            setText('r-val-muscle', res.muscleMass.toFixed(1) + ' kg');
            setText('r-val-fat', res.fatMass.toFixed(1) + ' kg');
            setText('r-val-bone', res.boneMass.toFixed(1) + ' kg');
            setText('r-val-residual', res.residualMass.toFixed(1) + ' kg');

            setText('t-bf-curr', res.bodyFatPercent.toFixed(1) + '%');
            setText('t-bf-ideal', '~' + res.idealBodyFatPercent + '%');
            setText('t-fm-curr', res.fatMass.toFixed(1));
            setText('t-fm-ideal', (patientData.weight * (res.idealBodyFatPercent/100)).toFixed(1));
            setText('t-mm-curr', res.muscleMass.toFixed(1));

            $('range-bars-container').innerHTML = 
                generateRangeBar('IMC', res.bmi, '', 22, 15, 35) +
                generateRangeBar('Gordura %', res.bodyFatPercent, '', res.idealBodyFatPercent, 5, 40);

            const sfLabels = { 
                chest: 'Peitoral', axilla: 'Axilar', tricep: 'Tríceps', 
                subscapular: 'Subesca.', abdomen: 'Abd.', 
                suprailiac: 'Supra', thigh: 'Coxa' 
            };
            $('r-skinfolds-grid').innerHTML = Object.entries(skinfolds).map(([key, value]) => `
                <div class="flex justify-between items-center border-b border-gray-100 py-1 last:border-0">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">${sfLabels[key]}</span>
                    <span class="text-xs font-bold text-gray-700">${value}</span>
                </div>
            `).join('');

            $('circumferences-table-body').innerHTML = `
                <tr><td class="font-medium text-gray-600">Braço Relax.</td><td class="text-center">${circs.armLeftRelaxed||'-'}</td><td class="text-center">${circs.armRightRelaxed||'-'}</td></tr>
                <tr><td class="font-medium text-gray-600">Braço Contr.</td><td class="text-center">${circs.armLeftContracted||'-'}</td><td class="text-center">${circs.armRightContracted||'-'}</td></tr>
                <tr><td class="font-medium text-gray-600">Coxa Medial</td><td class="text-center">${circs.thighLeftMedial||'-'}</td><td class="text-center">${circs.thighRightMedial||'-'}</td></tr>
                <tr><td class="font-medium text-gray-600">Panturrilha</td><td class="text-center">${circs.calfLeft||'-'}</td><td class="text-center">${circs.calfRight||'-'}</td></tr>
                <tr class="bg-gray-50 print:bg-gray-100"><td colspan="3" class="text-[9px] font-bold uppercase text-center py-1 text-gray-400">Tronco</td></tr>
                <tr><td class="font-medium text-gray-600">Pescoço</td><td colspan="2" class="text-center font-bold">${circs.neck||'-'}</td></tr>
                <tr><td class="font-medium text-gray-600">Tórax</td><td colspan="2" class="text-center font-bold">${circs.chest||'-'}</td></tr>
                <tr><td class="font-medium text-gray-600">Abdome</td><td colspan="2" class="text-center font-bold">${circs.abdomen||'-'}</td></tr>
                <tr><td class="font-medium text-gray-600">Cintura</td><td colspan="2" class="text-center font-bold">${circs.waist||'-'}</td></tr>
                <tr><td class="font-medium text-gray-600">Quadril</td><td colspan="2" class="text-center font-bold">${circs.hip||'-'}</td></tr>
            `;

            $('form-view').classList.add('hidden');
            $('report-view').classList.remove('hidden');
            setTimeout(() => { 
                $('report-view').style.opacity = '1';
                renderDietPlanner(); 
            }, 100);
        };

        const handleBack = () => {
            $('report-view').style.opacity = '0';
            setTimeout(() => {
                $('report-view').classList.add('hidden');
                $('form-view').classList.remove('hidden');
            }, 500);
        };

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            $('calc-form').addEventListener('submit', handleFormSubmit);
            $('btn-back').addEventListener('click', handleBack);
            $('btn-print').addEventListener('click', () => window.print());

            const tabAssess = $('tab-assess');
            const tabDiet = $('tab-diet');
            const contentAssess = $('content-assessment');
            const contentDiet = $('content-diet');

            const switchTab = (toDiet) => {
                if(toDiet) {
                    tabDiet.className = "flex-1 md:flex-none px-4 py-3 font-semibold text-sm tracking-wide text-nature-700 border-nature-600 bg-nature-50/50 rounded-t-lg border-b-2 text-center transition-all";
                    tabAssess.className = "flex-1 md:flex-none px-4 py-3 font-semibold text-sm tracking-wide text-earth-800 border-b-2 border-transparent transition-all duration-300 hover:text-nature-600 text-center";
                    contentAssess.classList.add('hidden');
                    contentDiet.classList.remove('hidden');
                } else {
                    tabAssess.className = "flex-1 md:flex-none px-4 py-3 font-semibold text-sm tracking-wide text-nature-700 border-nature-600 bg-nature-50/50 rounded-t-lg border-b-2 text-center transition-all";
                    tabDiet.className = "flex-1 md:flex-none px-4 py-3 font-semibold text-sm tracking-wide text-earth-800 border-b-2 border-transparent transition-all duration-300 hover:text-nature-600 text-center";
                    contentDiet.classList.add('hidden');
                    contentAssess.classList.remove('hidden');
                }
            };
            
            tabAssess.addEventListener('click', () => switchTab(false));
            tabDiet.addEventListener('click', () => switchTab(true));

            // Food Search
            const searchInput = $('food-search');
            const resultsBox = $('food-search-results');
            let selectedFoodId = null;

            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                if(term.length < 2) return resultsBox.classList.add('hidden');
                const matches = TACO_DB.filter(f => f.name.toLowerCase().includes(term));
                if(matches.length > 0) {
                    resultsBox.innerHTML = matches.map(f => 
                        `<div class="search-item" onclick="selectFood(${f.id}, '${f.name}')">
                            <span class="font-bold text-nature-800">${f.name}</span> 
                            <span class="text-xs text-gray-400 ml-2">(${f.kcal}kcal/100g)</span>
                        </div>`
                    ).join('');
                    resultsBox.classList.remove('hidden');
                } else resultsBox.classList.add('hidden');
            });

            window.selectFood = (id, name) => {
                selectedFoodId = id;
                searchInput.value = name;
                resultsBox.classList.add('hidden');
            };

            document.addEventListener('click', (e) => {
                if(!e.target.closest('#food-search-results') && e.target !== searchInput) resultsBox.classList.add('hidden');
            });

            $('btn-add-food').addEventListener('click', () => {
                if(!selectedFoodId) return alert("Selecione um alimento da lista");
                const qty = getValue('food-qty');
                const meal = $('food-meal-select').value;
                if(qty <= 0) return alert("Quantidade inválida");
                addFoodToDiet(selectedFoodId, meal, qty);
                searchInput.value = '';
                selectedFoodId = null;
                $('food-qty').value = '100';
            });
        });
    </script>
</body>
</html>
